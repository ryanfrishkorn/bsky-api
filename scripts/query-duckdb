#!/usr/bin/env bash

# DuckDB Query Notes

set -eo pipefail

DATABASE="${HOME}/.jetstream.duckdb"
OUTPUT_LIST=1 ; cfg_list() { return $OUTPUT_LIST; }
declare -a ARGS

# Script Function List
usage() {
    printf "script functions:\n"
    printf "  common-terms  Show most common terms and stats from FTS index\n"
    printf "  search        Search for posts using FTS match for term\n"
    exit 1
}

# Functions

# Use FTS match for supplied term
search() {
    local term # $1
    local limit ; limit=100000
    local order_clause
    local query
    local sort_time ; sort_time=0
    declare -a args

    while (( $# > 0 )); do
        case $1 in
            --limit)
                shift
                limit=$1
                ;;
            --time)
                shift
                sort_time=1
                ;;
            *)
                args+=("$1")
                shift
                ;;
        esac
    done

    term="${args[0]}"
    require-arg "$term"

    if ((sort_time)); then
        order_clause="order by created_at desc"
    else
        order_clause="order by score desc"
    fi

    read -r -d '' query <<-SQL || true
    select
        substr(fts_main_posts.match_bm25(cid, '$term', fields := 'text', k := 1.2, b := 0.75, conjunctive := 1)::VARCHAR, 0, 8) as s,
        fts_main_posts.match_bm25(cid, '$term', fields := 'text', k := 1.2, b := 0.75, conjunctive := 1) as score,
        substr(created_at::VARCHAR, 0, 17) as ts,
        substr(did, 9) as did,
        text
    from posts
    where score not null
    $order_clause
    limit $limit;
SQL

    run-query "$query"
}

# Show most common stems using fts index
common-terms() {
    local query

    read -r -d '' query <<-SQL || true
        select count, s.termid, t.term
        from (
            select count() as count,
            termid from fts_main_posts.terms
            group by termid
        ) as s
        inner join fts_main_posts.dict as t
        on t.termid = s.termid
        order by count desc
        limit 40;
SQL

    run-query "$query"
}

# Execute duckdb query
run-query() {
    declare -a cmd
    local query

    query=$1
    require-arg "$query"

    # prepend timezone set
    query="$(printf "set time zone 'UTC'; %s" "$query")"

    cmd+=(duckdb -readonly)
    # optional list output
    if cfg_list; then
        cmd+=(-list)
    else
        # default json output
        cmd+=(-json)
    fi
    cmd+=("$DATABASE")

    # use jq if json output
    if cfg_list; then
        "${cmd[@]}" < <(printf "%s\n" "$query")
    else
        # use jq for compact single-line item format
        jq -c '.[] | { ts, did, s, text }' < <("${cmd[@]}" < <(printf "%s\n" "$query"))
    fi
}

# Utility Functions
require-arg() {
    if [[ -z $1 ]]; then
        printf "required argument missing\n" 1>&2
        return 1
    fi
    return 0
}

# Function Invocations

# Check options
for arg in "$@"; do
    case $arg in
        --help|-h)
            shift
            usage
            ;;
        --list)
            shift
            OUTPUT_LIST=0 # true
            ;;
        *)
            ARGS+=("$arg")
            shift
            ;;
    esac
done

"${ARGS[@]}"
