#!/usr/bin/env bash

set -eo pipefail

SCRIPT_NAME=$(basename "$0")

require_bin() {
    if which "${1}" >/dev/null; then
        return 0
    fi
    printf "missing binary: %s\n" "${1}"
    exit 1
}

require_file() {
    # one argument only
    if [[ $# != 1 ]]; then
        printf "%s: supply a single file argument\n" "${0}"
        exit 1
    fi
    
    # check file existence
    if [[ -f "${1}" ]]; then
        return 0
    fi
    printf "file not found: %s\n" "${1}"
    exit 1
}

require_no_file() {
    if [[ -f "${1}" ]]; then
        printf "file already exists: %s\n" "${1}"
        exit 1
    fi
    return 0
}

build_from_sqlite() {
    local sqlite_source
    local duckdb_dest
    declare -a cmd

    duckdb_dest=$1
    sqlite_source=$2

    # create schema
    read -r -d '' create_query <<-SQL
        create table if not exists posts (did VARCHAR, cid VARCHAR UNIQUE, created_at TIMESTAMPTZ, text VARCHAR);
SQL
    cmd=(duckdb "$duckdb_dest")
    "${cmd[@]}" < <(printf "%s" "$create_query")

    cmd=(duckdb "$duckdb_dest")

    read -r -d '' build_query <<-SQL
        load sqlite;
        attach '$sqlite_source' as js (TYPE sqlite, READONLY true);
        insert or ignore into posts
        select did, cid,
        case
            when json_exists(feedpost, '$.createdAt')
            then json_extract_string(feedpost, '$.createdAt')::TIMESTAMPTZ
            else NULL
        end as created_at,
        case
            when json_exists(feedpost, '$.text')
            then json_extract_string(feedpost, '$.text')
            else NULL
        end as text
        from js.posts
        where json_extract(feedpost, '$.langs') = '["en"]'
        order by rowid
SQL

    # and (
    #     json_extract(feedpost, '$.langs') = '["en"]'
    #     or json_extract(feedpost, '$.langs') = ''
    #     or json_extract(feedpost, '$.langs') is null
    # )

    "${cmd[@]}" < <(printf "%s" "$build_query") >/dev/null
}

file_info() {
    for f in "$@"; do
        printf "%s %s bytes\n" "${f}" "$(stat -c "%s" "${f}")"
    done
}

# create fts index
fts_index() {
    local file_duck
    local cmd
    file_duck=$1

    cmd=$(printf "pragma create_fts_index(posts, cid, text, stemmer = 'porter', stopwords = 'english', ignore = '(\\.|[^a-z])+', strip_accents = 1, lower = 1, overwrite = 0)")
    duckdb "${file_duck}" "${cmd}"
}

# drop existing fts index
fts_drop() {
    local file_duck
    file_duck=$1

    duckdb "${file_duck}" "pragma drop_fts_index(posts)"
}

usage() {
    printf "%s [input.sqlite3]\n" "${SCRIPT_NAME}"
    printf "  --append  Append to existing duck database\n"
    exit 1
}

# check for help args
for arg in "$@"; do
    if [[ "${arg}" == "--help" ]] || [[ "${arg}" == "-h" ]]; then
        usage
    fi
done

declare -a args
append=1 ; is_append() { return $append; } # false

while [[ $# -gt 0 ]]; do
    case $1 in
        "--append")
            shift
            append=0
            ;;
        *)
            args+=("$1")
            shift
            ;;
    esac
done

require_bin duckdb

duckdb_dest="${args[0]:-data/jetstream.duckdb}"
duckdb_dest_tmp="${duckdb_dest}.tmp"
# time_start=${args[0]:-"$(TZ=UTC date -I)T00:00:00"}
# time_stop=${args[1]:-"$(TZ=UTC date -I)T23:59:59"}

printf "%s starting build\n" "$(TZ=UTC date)"

# remove tmp database in case of previous failure
if [[ -f "$duckdb_dest_tmp" ]]; then
    rm "$duckdb_dest_tmp" &>/dev/null
fi

if is_append; then
    # no temporary file
    duckdb_dest_tmp=$duckdb_dest
    printf "appending to database %s\n" "$duckdb_dest"
else
    printf "building new database %s\n" "$duckdb_dest"
fi

# iterate through sqlite files to import
for sqlite_db in "${args[@]:1}"; do
    printf "%s ... " "$sqlite_db"

    if ! build_from_sqlite "${duckdb_dest_tmp}" "${sqlite_db}"; then
        printf "error\n"
        exit 1
    fi
    printf "ok\n"
done

if is_append; then
    printf "dropping existing fts index ... "
    if ! fts_drop "${duckdb_dest_tmp}"; then
        printf "error\n"
        exit 1
    fi
    printf "ok\n"

    printf "implementing fts ... "
    if ! fts_index "${duckdb_dest_tmp}" true; then
        printf "error\n"
        exit 1
    fi
    printf "ok\n"
else
    printf "implementing fts ... "
    if ! fts_index "${duckdb_dest_tmp}"; then
        printf "error\n"
        exit 1
    fi
    printf "ok\n"
fi

if ! is_append; then
    printf "replacing database ... "
    if ! mv "${duckdb_dest_tmp}" "${duckdb_dest}"; then
        printf "error\n"
        exit 1
    fi
    printf "ok\n"
fi

printf "%s build complete\n" "$(TZ=UTC date)"
